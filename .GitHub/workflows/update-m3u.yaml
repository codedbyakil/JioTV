name: Auto-Update M3U

permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Generate jiotv.m3u
        run: |
          echo "ðŸ“¥ Fetching Ziotv.json..."
          JSON=$(curl -sf \
            -H "User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36" \
            -H "Accept: application/json" \
            -H "Referer: https://playify.pages.dev/" \
            "https://playify.pages.dev/Ziotv.json") || { echo "âŒ Fetch failed"; exit 1; }
          
          if ! echo "$JSON" | jq empty >/dev/null 2>&1; then
            echo "âŒ Invalid JSON"; exit 1
          fi
          
          echo "#EXTM3U" > jiotv.m3u
          echo "$JSON" | jq -r '
            .[] |
            "#EXTINF:-1 group-title=\"JioStar\"," + (.name // "Unknown") + "\n" +
            (if .drmScheme == "clearkey" and .drmLicense then 
              "#KODIPROP:inputstream.adaptive.license_type=clearkey\n" +
              "#KODIPROP:inputstream.adaptive.license_key=" + (.drmLicense | split(":")[0:2] | join(":")) + "\n"
            else "" end) +
            "#EXTVLCOPT:http-user-agent=plaYtv/7.1.5%20(Linux%3BAndroid%2015)%20ExoPlayerLib/2.11.6%20YGX/69.69.69.69\n" +
            (.link // "") + "\n"
          ' >> jiotv.m3u
          
          echo "âœ… jiotv.m3u created ($(wc -c < jiotv.m3u) bytes)"
          head -n 5 jiotv.m3u

      - name: Commit & Push
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add jiotv.m3u

          # Check staged changes
          if git diff --cached --quiet; then
            echo "âž¡ï¸ No changes â€” skipping commit"
            exit 0
          fi

          git commit -m "âœ… Auto-update M3U: $(date -u '+%Y-%m-%d %H:%M')"

          # Use personal access token for pushing (required for GitHub Actions on default branch)
          git remote set-url origin https://x-access-token:${GH_PAT}@github.com/${GITHUB_REPOSITORY}.git
          git push origin main
