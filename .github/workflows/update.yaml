name: Auto-Update M3U

permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Generate jiotv.m3u
        run: |
          echo "üì• Fetching Ziotv.json..."
          JSON_URL="https://playify.pages.dev/Ziotv.json"
          JSON=$(curl -sf \
            -H "User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36" \
            -H "Accept: application/json" \
            -H "Referer: https://playify.pages.dev/" \
            "$JSON_URL") || { echo "‚ùå Failed to fetch JSON from $JSON_URL"; exit 1; }

          # Validate JSON
          if ! echo "$JSON" | jq empty >/dev/null 2>&1; then
            echo "‚ùå Invalid or empty JSON"
            echo "First 200 chars: $(echo "$JSON" | head -c 200)"
            exit 1
          fi

          # Start M3U file
          echo "#EXTM3U" > jiotv.m3u

          # Generate entries ‚Äî safe, quoted, no syntax errors
          echo "$JSON" | jq -r '
            .[] |
            # Build #EXTINF line
            "#EXTINF:-1 " +
            (if has("tvg_id") and (.tvg_id | type == "string") and (.tvg_id | length > 0)
              then "tvg-id=\"\(.tvg_id)\" " else "" end) +
            "group-title=\"JioStar\" " +
            (if has("tvg_logo") and (.tvg_logo | type == "string") and (.tvg_logo | length > 0)
              then "tvg-logo=\"\(.tvg_logo)\" " else "" end) +
            ",\(.name // "Unknown")" |
            # Escape quotes in name (just in case)
            gsub(","; "\\,") |
            . as $extinf |
            # Build optional DRM lines
            (if (.drmScheme // "") == "clearkey" and (.drmLicense // "") | test("^[a-fA-F0-9]+:[a-fA-F0-9]+") then
              "#KODIPROP:inputstream.adaptive.license_type=clearkey\n#KODIPROP:inputstream.adaptive.license_key=" + 
              (.drmLicense | split(":")[0:2] | join(":"))
            else "" end) as $drm |
            # Build UA line
            "#EXTVLCOPT:http-user-agent=plaYtv/7.1.5%20(Linux%3BAndroid%2015)%20ExoPlayerLib/2.11.6%20YGX/69.69.69.69" as $ua |
            # Build cookie line (escape JSON quotes)
            (if has("cookie") and (.cookie | type == "string") and (.cookie | length > 0) then
              "#EXTHTTP:{\"cookie\":\"" + (.cookie | gsub("\""; "\\\"")) + "\"}"
            else "" end) as $cookie |
            # Final URL
            (.link // "") as $url |
            # Assemble all lines (skip empty ones)
            [
              $extinf,
              ($drm | select(. != "")),
              $ua,
              ($cookie | select(. != "")),
              ($url | select(. != ""))
            ] | join("\n")
          ' >> jiotv.m3u

          # Final validation
          if [ ! -s jiotv.m3u ]; then
            echo "‚ùå jiotv.m3u is empty!"
            exit 1
          fi

          echo "‚úÖ jiotv.m3u created ($(wc -l < jiotv.m3u) lines, $(wc -c < jiotv.m3u) bytes)"
          echo "üîé First channel block:"
          awk '/^#EXTINF/,/^https?:/ { print; if (/^https?:/) exit }' jiotv.m3u || true

      - name: Commit & Push (using GITHUB_TOKEN only)
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add jiotv.m3u

          if git diff --cached --quiet; then
            echo "‚û°Ô∏è No changes ‚Äî skipping commit"
            exit 0
          fi

          git commit -m "‚úÖ Auto-update M3U: $(date -u '+%Y-%m-%d %H:%M')"
          git push origin main
